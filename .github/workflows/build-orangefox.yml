name: æ„å»º OnePlus 13 (PJZ110) OrangeFox Recovery

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox åˆ†æ”¯ç‰ˆæœ¬ (Android ç‰ˆæœ¬)'
        required: true
        default: '15.0'
        type: choice
        options:
          - '15.0'
          - '16.0'
      MAGISK_VERSION:
        description: 'Magisk Alpha ç‰ˆæœ¬'
        required: true
        default: 'v29.0-alpha'
        type: string
      USE_CCACHE:
        description: 'å¯ç”¨ CCache åŠ é€Ÿç¼–è¯‘'
        required: false
        default: true
        type: boolean

jobs:
  build:
    name: ç¼–è¯‘ OrangeFox Recovery
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    env:
      DEVICE_NAME: PJZ110
      DEVICE_PATH: device/oplus/PJZ110
      DEVICE_TREE: https://github.com/${{ github.repository }}
      DEVICE_TREE_BRANCH: ${{ github.ref_name }}
      BUILD_TARGET: recovery
      MANIFEST_BRANCH: ${{ inputs.MANIFEST_BRANCH || '15.0' }}
      MAGISK_VERSION: ${{ inputs.MAGISK_VERSION || 'v29.0-alpha' }}
      USE_CCACHE: ${{ inputs.USE_CCACHE || true }}

    steps:
      - name: ç¬¬ 1 æ­¥ - æ£€æŸ¥å¯ç”¨ç£ç›˜ç©ºé—´
        run: |
          echo "ğŸ” æ£€æŸ¥åˆå§‹ç£ç›˜ç©ºé—´..."
          df -h
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
      - name: ç¬¬ 2 æ­¥ - æ¸…ç†ç£ç›˜ç©ºé—´ (é‡Šæ”¾çº¦ 30GB)
        run: |
          echo "ğŸ§¹ æ­£åœ¨æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶ä»¥é‡Šæ”¾ç£ç›˜ç©ºé—´..."
          
          # åˆ é™¤ä¸å¿…è¦çš„é¢„è£…è½¯ä»¶
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          
          # æ¸…ç† APT ç¼“å­˜
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          
          # æ¸…ç† Docker
          docker rmi $(docker images -q) || true
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/graalvm/
          sudo rm -rf /usr/local/.ghcup/
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /usr/local/lib/node_modules
          
          echo "âœ… ç£ç›˜æ¸…ç†å®Œæˆ"
          echo "ğŸ“Š æ¸…ç†åçš„ç£ç›˜ç©ºé—´ï¼š"
          df -h

      - name: ç¬¬ 3 æ­¥ - æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          path: device-tree

      - name: ç¬¬ 4 æ­¥ - å®‰è£…æ„å»ºä¾èµ–
        run: |
          echo "ğŸ“¦ æ­£åœ¨å®‰è£…ç³»ç»Ÿä¾èµ–åŒ…..."
          sudo apt-get update
          sudo apt-get install -y \
            bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib git git-lfs gnupg gperf \
            imagemagick lib32readline-dev lib32z1-dev libelf-dev \
            liblz4-tool libsdl1.2-dev libssl-dev libxml2 \
            libxml2-utils lzop pngcrush rsync schedtool \
            squashfs-tools xsltproc zip zlib1g-dev \
            openjdk-11-jdk python3 python-is-python3 \
            aria2 repo
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ç¬¬ 5 æ­¥ - é…ç½® Git
        run: |
          echo "âš™ï¸ é…ç½® Git ç”¨æˆ·ä¿¡æ¯..."
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          echo "âœ… Git é…ç½®å®Œæˆ"

      - name: ç¬¬ 6 æ­¥ - åŒæ­¥ OrangeFox æºç  (ç²¾ç®€æ¨¡å¼)
        run: |
          echo "ğŸ¦Š æ­£åœ¨åŒæ­¥ OrangeFox ${{ env.MANIFEST_BRANCH }} æºç ..."
          mkdir -p ${GITHUB_WORKSPACE}/OrangeFox
          cd ${GITHUB_WORKSPACE}/OrangeFox
          git clone https://gitlab.com/OrangeFox/sync.git
          cd sync
          ./orangefox_sync.sh --branch ${{ env.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}
          echo "âœ… OrangeFox æºç åŒæ­¥å®Œæˆ"
          
          echo "ğŸ“Š åŒæ­¥åçš„ç£ç›˜ç©ºé—´ï¼š"
          df -h

      - name: ç¬¬ 7 æ­¥ - å…‹éš†è®¾å¤‡æ ‘
        run: |
          echo "ğŸŒ³ æ­£åœ¨å…‹éš† OnePlus 13 (PJZ110) è®¾å¤‡æ ‘..."
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}
          mkdir -p ./${{ env.DEVICE_PATH }}
          cp -r ${GITHUB_WORKSPACE}/device-tree/* ./${{ env.DEVICE_PATH }}/
          
          cd ${{ env.DEVICE_PATH }}
          COMMIT_ID=$(git rev-parse HEAD)
          echo "COMMIT_ID=${COMMIT_ID}" >> $GITHUB_ENV
          echo "ğŸ“ è®¾å¤‡æ ‘æäº¤ ID: ${COMMIT_ID}"
          echo "âœ… è®¾å¤‡æ ‘å…‹éš†å®Œæˆ"

      - name: ç¬¬ 8 æ­¥ - ä¸‹è½½ Magisk Alpha ç‰ˆæœ¬
        run: |
          echo "ğŸ”® æ­£åœ¨ä¸‹è½½ Magisk Alpha ${{ env.MAGISK_VERSION }}..."
          mkdir -p ~/magisk_alpha
          cd ~/magisk_alpha
          
          # ä» GitHub Releases ä¸‹è½½æœ€æ–°çš„ Magisk Alpha
          wget -O Magisk-${{ env.MAGISK_VERSION }}.apk https://github.com/topjohnwu/Magisk/releases/download/${{ env.MAGISK_VERSION }}/Magisk-${{ env.MAGISK_VERSION }}.apk || \
          wget -O Magisk-${{ env.MAGISK_VERSION }}.apk https://github.com/topjohnwu/Magisk/releases/download/canary-latest/app-release.apk
          
          echo "âœ… Magisk Alpha ä¸‹è½½å®Œæˆ"
          ls -lh Magisk-*.apk

      - name: ç¬¬ 9 æ­¥ - æ›´æ–° OrangeFox å†…ç½® Magisk Alpha
        run: |
          echo "ğŸ”® æ­£åœ¨é›†æˆ Magisk Alpha åˆ° OrangeFox..."
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/${{ env.DEVICE_PATH }}
          
          if ! grep -q 'FOX_USE_SPECIFIC_MAGISK_ZIP' vendorsetup.sh; then
            echo "export FOX_USE_SPECIFIC_MAGISK_ZIP=~/magisk_alpha/Magisk-${{ env.MAGISK_VERSION }}.apk" >> vendorsetup.sh
            echo "âœ… å·²åœ¨ vendorsetup.sh ä¸­æ·»åŠ  Magisk Alpha é…ç½®"
          else
            sed -i "s|.*export FOX_USE_SPECIFIC_MAGISK_ZIP.*|export FOX_USE_SPECIFIC_MAGISK_ZIP=~/magisk_alpha/Magisk-${{ env.MAGISK_VERSION }}.apk|" vendorsetup.sh
            echo "âœ… å·²æ›´æ–° vendorsetup.sh ä¸­çš„ Magisk Alpha é…ç½®"
          fi
          
          echo "ğŸ“¦ å½“å‰ Magisk é…ç½®:"
          grep FOX_USE_SPECIFIC_MAGISK_ZIP vendorsetup.sh

      - name: ç¬¬ 10 æ­¥ - æ›´æ–° OrangeFox å†…ç½® magiskboot
        run: |
          echo "ğŸ¥¾ æ­£åœ¨æ›´æ–°å†…ç½® magiskboot..."
          git clone https://github.com/magojohnji/magiskboot-linux ~/magiskboot-linux
          
          cp -f ~/magiskboot-linux/armeabi-v7a/magiskboot "${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/vendor/recovery/prebuilt/arm/magiskboot_updated"
          cp -f ~/magiskboot-linux/arm64-v8a/magiskboot "${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/vendor/recovery/prebuilt/arm64/magiskboot_updated"
          cp -f ~/magiskboot-linux/x86_64/magiskboot "${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/vendor/recovery/tools/magiskboot"
          echo "âœ… magiskboot æ›´æ–°å®Œæˆ"

      - name: ç¬¬ 11 æ­¥ - é›†æˆ SukiSU Ultra åˆ°è®¾å¤‡æ ‘
        run: |
          echo "ğŸŒ¸ æ­£åœ¨é›†æˆ SukiSU Ultra Root ç®¡ç†å™¨..."
          
          # åˆ›å»º SukiSU Ultra ç›®å½•
          mkdir -p ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/${{ env.DEVICE_PATH }}/recovery/root/FFiles/SukiSU_Ultra
          
          # ä¸‹è½½æœ€æ–°çš„ SukiSU Ultra
          cd ~/
          git clone --depth=1 https://github.com/Kartatz/SukiSU.git sukisu_repo || echo "ä½¿ç”¨å¤‡ç”¨ä¸‹è½½æ–¹å¼..."
          
          # å¦‚æœæœ‰é¢„ç¼–è¯‘çš„ SukiSU Ultraï¼Œå¤åˆ¶åˆ°è®¾å¤‡æ ‘
          if [ -f ~/sukisu_repo/SukiSU-Ultra.zip ]; then
            cp ~/sukisu_repo/SukiSU-Ultra.zip ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/${{ env.DEVICE_PATH }}/recovery/root/FFiles/SukiSU_Ultra/
            echo "âœ… SukiSU Ultra å·²æ·»åŠ åˆ°è®¾å¤‡æ ‘ FFiles ç›®å½•"
          else
            # å¦‚æœæ²¡æœ‰é¢„ç¼–è¯‘ç‰ˆæœ¬ï¼Œä» Release ä¸‹è½½
            wget -O ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/${{ env.DEVICE_PATH }}/recovery/root/FFiles/SukiSU_Ultra/SukiSU_Ultra.zip \
              https://github.com/Kartatz/SukiSU/releases/latest/download/SukiSU-Ultra.zip || \
              echo "âš ï¸ SukiSU Ultra ä¸‹è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨è®¾å¤‡æ ‘ç°æœ‰ç‰ˆæœ¬"
          fi
          
          # éªŒè¯æ–‡ä»¶
          ls -lh ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/${{ env.DEVICE_PATH }}/recovery/root/FFiles/SukiSU_Ultra/ || echo "ä½¿ç”¨ç°æœ‰æ–‡ä»¶"
          
          echo "âœ… SukiSU Ultra é›†æˆå®Œæˆ"

      - name: ç¬¬ 12 æ­¥ - é…ç½® CCache (å¯é€‰)
        if: env.USE_CCACHE == 'true'
        run: |
          echo "âš¡ æ­£åœ¨é…ç½® CCache ä»¥åŠ é€Ÿç¼–è¯‘ï¼ˆé™åˆ¶ 5GBï¼‰..."
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}
          
          export USE_CCACHE=1
          export CCACHE_EXEC=/usr/bin/ccache
          ccache -M 5G
          ccache -z
          
          # ç¦ç”¨æ²™ç›’ä»¥å…¼å®¹ CCache
          sed -i 's/return sandboxConfig\.working/return false/g' build/soong/ui/build/sandbox_linux.go
          echo "âœ… CCache é…ç½®å®Œæˆ"

      - name: ç¬¬ 13 æ­¥ - ç¼–è¯‘å‰æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          sudo rm -rf /tmp/*
          sudo apt-get clean
          echo "ğŸ“Š ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ï¼š"
          df -h

      - name: ç¬¬ 14 æ­¥ - ç¼–è¯‘ OrangeFox Recovery
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ OnePlus 13 (PJZ110) OrangeFox Recovery..."
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}
          
          set +e
          export FOX_BUILD_DEVICE=${{ env.DEVICE_NAME }}
          export ALLOW_MISSING_DEPENDENCIES=true
          
          if [[ ${{ env.USE_CCACHE }} == true ]]; then
            export USE_CCACHE=1
            export CCACHE_EXEC=/usr/bin/ccache
          fi
          
          source build/envsetup.sh
          set -e
          
          echo "ğŸ½ï¸ æ‰§è¡Œ lunch twrp_${{ env.DEVICE_NAME }}-eng..."
          lunch twrp_${{ env.DEVICE_NAME }}-eng
          
          echo "ğŸ§¹ æ¸…ç†ä¹‹å‰çš„ç¼–è¯‘äº§ç‰©..."
          make clean
          
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ (ä½¿ç”¨ $(nproc --all) ä¸ªçº¿ç¨‹)..."
          mka adbd ${{ env.BUILD_TARGET }}image -j$(nproc --all)
          
          echo "âœ… ç¼–è¯‘å®Œæˆï¼"

      - name: ç¬¬ 15 æ­¥ - æ˜¾ç¤º CCache ç»Ÿè®¡
        if: env.USE_CCACHE == 'true'
        run: |
          echo "ğŸ“Š CCache ä½¿ç”¨ç»Ÿè®¡ï¼š"
          ccache -s

      - name: ç¬¬ 16 æ­¥ - è®¾ç½®å‘å¸ƒä¿¡æ¯
        run: |
          echo "ğŸ“‹ æ­£åœ¨è®¾ç½®å‘å¸ƒä¿¡æ¯..."
          BUILD_DATE=$(TZ=Asia/Shanghai date +%Y%m%d)
          echo "BUILD_DATE=${BUILD_DATE}" >> $GITHUB_ENV
          echo "ğŸ“… ç¼–è¯‘æ—¥æœŸ: ${BUILD_DATE}"
          
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}
          
          DEVICE_TREE_URL="${{ env.DEVICE_TREE }}"
          if [[ "${DEVICE_TREE_URL}" == *.git ]]; then
            DEVICE_TREE_URL="${DEVICE_TREE_URL%.git}"
          fi
          echo "DEVICE_TREE_URL=${DEVICE_TREE_URL}" >> $GITHUB_ENV
          echo "âœ… å‘å¸ƒä¿¡æ¯è®¾ç½®å®Œæˆ"

      - name: ç¬¬ 17 æ­¥ - æ£€æŸ¥ç¼–è¯‘äº§ç‰©
        run: |
          echo "ğŸ” æ­£åœ¨æ£€æŸ¥ç¼–è¯‘äº§ç‰©..."
          cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/out/target/product/${{ env.DEVICE_NAME }}
          
          if ls OrangeFox*.img 1> /dev/null 2>&1; then
            echo "âœ… æ‰¾åˆ° OrangeFox IMG æ–‡ä»¶:"
            ls -lh OrangeFox*.img
          fi
          
          if ls OrangeFox*.zip 1> /dev/null 2>&1; then
            echo "âœ… æ‰¾åˆ° OrangeFox ZIP æ–‡ä»¶:"
            ls -lh OrangeFox*.zip
          fi

      - name: ç¬¬ 18 æ­¥ - ä¸Šä¼ ç¼–è¯‘äº§ç‰©åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/out/target/product/${{ env.DEVICE_NAME }}/OrangeFox*.img
            OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/out/target/product/${{ env.DEVICE_NAME }}/OrangeFox*.zip
          name: OrangeFox Recovery for OnePlus 13 (PJZ110) // ${{ env.BUILD_DATE }}
          tag_name: ${{ github.run_id }}
          body: |
            ## ğŸ¦Š OrangeFox Recovery ç¼–è¯‘ç‰ˆæœ¬ - éå®˜æ–¹
            
            ### ğŸ“± è®¾å¤‡ä¿¡æ¯
            - **è®¾å¤‡åç§°**: OnePlus 13
            - **ä»£å·**: PJZ110
            - **å‚å•†**: OPLUS
            
            ### ğŸ”§ ç¼–è¯‘ä¿¡æ¯
            - **OrangeFox åˆ†æ”¯**: fox_${{ env.MANIFEST_BRANCH }} (Android ${{ env.MANIFEST_BRANCH }})
            - **ç¼–è¯‘æ—¥æœŸ**: ${{ env.BUILD_DATE }}
            - **Magisk Alpha ç‰ˆæœ¬**: ${{ env.MAGISK_VERSION }}
            - **ä½¿ç”¨ CCache**: ${{ env.USE_CCACHE }}
            
            ### ğŸŒ³ è®¾å¤‡æ ‘
            - **ä»“åº“**: [è®¾å¤‡æ ‘/åˆ†æ”¯](${{ env.DEVICE_TREE_URL }}/tree/${{ env.DEVICE_TREE_BRANCH }})
            - **æäº¤**: ç¼–è¯‘æ—¶çš„æœ€æ–° [æäº¤](${{ env.DEVICE_TREE_URL }}/commit/${{ env.COMMIT_ID }})
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - âœ… æ˜¾ç¤º
            - âœ… è§¦æ‘¸ (åŒ…æ‹¬ FastbootD)
            - âœ… è§£å¯†
            - âœ… åˆ·æœº
            - âœ… å¤‡ä»½ä¸æ¢å¤
            - âœ… MTP/OTG å­˜å‚¨
            - âœ… ADB/FastbootD
            - âœ… æ¢å¤å‡ºå‚è®¾ç½®
            - âœ… æŒ¯åŠ¨å™¨
            - âœ… æ˜¾ç¤ºä¸æŒ¯åŠ¨è®¾ç½®
            
            ### ğŸ“¦ åŒ…å«çš„ Root å·¥å…·
            - **Magisk Alpha** - ${{ env.MAGISK_VERSION }} (å†…ç½®äº Recovery)
            - **KernelSU** - å†…æ ¸çº§ Root è§£å†³æ–¹æ¡ˆ (å®‰è£…/å¸è½½ç¨‹åº)
            - **KernelSUN** - KernelSU å˜ä½“ç‰ˆæœ¬
            - **SukiSU** - è½»é‡çº§ Root æ–¹æ¡ˆ
            - **SukiSU Ultra** - SukiSU å¢å¼ºç‰ˆ ğŸ†•
            
            ### âš ï¸ å…è´£å£°æ˜
            æ­¤ä¸ºéå®˜æ–¹ç¼–è¯‘ç‰ˆæœ¬ï¼Œä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ã€‚åˆ·å…¥å‰è¯·åšå¥½å¤‡ä»½ï¼Œåˆ·æœºæœ‰é£é™©ï¼Œè¯·è°¨æ…æ“ä½œï¼
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç¬¬ 19 æ­¥ - ä¸Šä¼ ç¼–è¯‘äº§ç‰©åˆ° Artifacts (å¤‡ä»½)
        uses: actions/upload-artifact@v4
        with:
          name: OrangeFox-OnePlus13-PJZ110-${{ env.BUILD_DATE }}
          path: |
            OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/out/target/product/${{ env.DEVICE_NAME }}/OrangeFox*.img
            OrangeFox/fox_${{ env.MANIFEST_BRANCH }}/out/target/product/${{ env.DEVICE_NAME }}/OrangeFox*.zip
          retention-days: 30
          if-no-files-found: error

      - name: âœ… æ„å»ºå®Œæˆ
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ OrangeFox Recovery ç¼–è¯‘æˆåŠŸï¼"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“± è®¾å¤‡: OnePlus 13 (PJZ110)"
          echo "ğŸ¦Š ç‰ˆæœ¬: fox_${{ env.MANIFEST_BRANCH }} (Android ${{ env.MANIFEST_BRANCH }})"
          echo "ğŸ“… æ—¥æœŸ: ${{ env.BUILD_DATE }}"
          echo "ğŸ”® Magisk: ${{ env.MAGISK_VERSION }} (Alpha)"
          echo "ğŸŒ¸ Rootå·¥å…·: KernelSU + SukiSU + SukiSU Ultra"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

