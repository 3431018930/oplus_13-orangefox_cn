# .github/workflows/build.yml

# å·¥ä½œæµçš„åç§°
name: ç¼–è¯‘ OrangeFox æ¢å¤ (ä½¿ç”¨ GitHub Manifest é•œåƒ)

# è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    # æ“ä½œç³»ç»Ÿ
    runs-on: ubuntu-22.04
    permissions:
      contents: write 
      packages: write

    steps:
      # æ­¥éª¤ 1: âš™ï¸ å®‰è£…æ„å»ºæ‰€éœ€çš„ä¾èµ–é¡¹
      - name: 1. å®‰è£…ä¾èµ–é¡¹ (å…¼å®¹ Ubuntu 22.04+)
        run: |
          sudo apt-get update
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib \
          gcc-multilib git gnupg gperf imagemagick libelf-dev liblz4-tool libncurses5-dev \
          libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev openjdk-11-jdk python3 \
          libncurses5:i386 libstdc++6:i386 libz1:i386

      # æ­¥éª¤ 2: åˆå§‹åŒ–å¹¶åŒæ­¥ OrangeFox æºç  (åˆ‡æ¢åˆ° GitHub Manifest)
      - name: 2. ğŸ¦Š åˆå§‹åŒ–å’ŒåŒæ­¥ OrangeFox æºç 
        run: |
          # **é‡ç‚¹ä¿®å¤ï¼šåˆ‡æ¢åˆ° GitHub ä¸Šçš„ twrp æç®€ Manifest**
          # è¿™æ˜¯å®Œå…¨å…¬å¼€çš„ï¼Œæ— éœ€ä»»ä½•è®¤è¯
          TWRP_MANIFEST_URL="https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git"
          MANIFEST_BRANCH="twrp-12.1"
          
          # é…ç½® git èº«ä»½
          git config --global user.name "Build Bot"
          git config --global user.email "buildbot@github.com"
          
          mkdir -p ~/orangefox ~/bin
          export PATH=~/bin:$PATH
          
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          
          cd ~/orangefox
          
          echo "Initializing repo with public GitHub Manifest: $TWRP_MANIFEST_URL branch $MANIFEST_BRANCH"
          repo init -u $TWRP_MANIFEST_URL -b $MANIFEST_BRANCH
          
          # å…‹éš† OrangeFox ä¸“æœ‰éƒ¨åˆ†ï¼ˆæ­¤æ­¥éª¤æ›¿ä»£äº† Manifest æ–‡ä»¶ä¸­çš„ä¸“æœ‰é¡¹ç›®ï¼‰
          git clone https://gitlab.com/OrangeFox/bootable/Recovery.git -b fox_12.1 bootable/recovery
          git clone https://gitlab.com/OrangeFox/vendor/recovery.git -b fox_12.1 vendor/recovery
          
          # åŒæ­¥æºç  (è¿™æ¬¡åº”è¯¥èƒ½æ­£å¸¸ä¸‹è½½æ‰€æœ‰ AOSP/TWRP åŸºç¡€ç»„ä»¶)
          repo sync -c --no-tags --no-clone-bundle --force-sync -j$(nproc)

      # æ­¥éª¤ 3: å…‹éš†ä½ çš„è®¾å¤‡æ ‘
      - name: 3. ğŸŒ³ å…‹éš†è®¾å¤‡æ ‘
        run: |
          cd ~/orangefox
          # âš ï¸ **å¿…æ”¹é¡¹ #1:** ç¡®ä¿è·¯å¾„ä¸ä½ çš„è®¾å¤‡æ ‘ç»“æ„åŒ¹é…
          git clone https://github.com/3431018930/oplus_13-orangefox_cn.git device/oplus/oplus_13

      # æ­¥éª¤ 4: å¼€å§‹ç¼–è¯‘
      - name: 4. ğŸ”¨ è¿è¡Œç¼–è¯‘
        run: |
          cd ~/orangefox
          . build/envsetup.sh
          
          # âš ï¸ **å¿…æ”¹é¡¹ #2:** ç¡®ä¿ 'lunch' ç›®æ ‡æ­£ç¡®
          export ALLOW_MISSING_DEPENDENCIES=true
          export FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER=1
          lunch omni_oplus_13-eng
          
          # å¼€å§‹ç¼–è¯‘ 'recoveryimage'
          mka recoveryimage -j$(nproc)

      # æ­¥éª¤ 5: ä¸Šä¼ ç¼–è¯‘äº§ç‰© (recovery.img)
      - name: 5. ğŸ“¤ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: OrangeFox-Recovery-${{ github.sha }}
          # âš ï¸ **å¿…æ”¹é¡¹ #3:** ç¡®ä¿äº§ç‰©è·¯å¾„æ­£ç¡®
          path: ~/orangefox/out/target/product/oplus_13/recovery.img
          retention-days: 7
