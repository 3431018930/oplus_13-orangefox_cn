# .github/workflows/build.yml

# 工作流的名称
name: 编译 OrangeFox 恢复

# 触发工作流的事件
on:
  # 1. 当有代码推送到 'main' 分支时
  push:
    branches:
      - main
      - master  # 也包含 master 分支以防万一
  # 2. 允许你从 GitHub Actions 页面手动触发此工作流
  workflow_dispatch:

jobs:
  build:
    # 运行此作业的操作系统
    runs-on: ubuntu-latest

    steps:
      # 步骤 1: 安装构建所需的依赖项
      - name: 1. 安装依赖项
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib \
          gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev \
          lib32z1-dev libelf-dev liblz4-tool libncurses5-dev libsdl1.2-dev libssl-dev \
          libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools \
          xsltproc zip zlib1g-dev openjdk-11-jdk python3

      # 步骤 2: 初始化并同步 OrangeFox 源码
      # 注意：我们将使用你的设备树仓库，所以这里不 'checkout'
      - name: 2. 初始化和同步源码
        run: |
          # 配置 git
          git config --global user.name "Build Bot"
          git config --global user.email "buildbot@github.com"
          
          # 创建工作目录并进入
          mkdir -p ~/orangefox
          cd ~/orangefox
          
          # 下载 'repo' 工具
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          export PATH=~/bin:$PATH
          
          # 初始化 OrangeFox 12.1 源码库 (你需要确认这个分支是否正确)
          echo "Syncing OrangeFox sources..."
          repo init -u https://gitlab.com/OrangeFox/manifest.git -b 12.1 --depth=1
          
          # 同步源码 (只拉取当前分支，加快速度)
          repo sync --current-branch --no-tags --no-clone-bundle --force-sync -j$(nproc --all)

      # 步骤 3: 克隆你的设备树
      - name: 3. 克隆设备树
        run: |
          cd ~/orangefox
          # -----------------------------------------------------------------
          # 警告: 你必须修改 'device/oplus/oplus_13' 这个路径
          # 这应该与你的设备树在 OrangeFox 源码中的预期路径相匹配
          # -----------------------------------------------------------------
          git clone https://github.com/3431018930/oplus_13-orangefox_cn.git device/oplus/oplus_13

      # 步骤 4: 开始编译
      - name: 4. 运行编译
        run: |
          cd ~/orangefox
          
          # 设置构建环境
          . build/envsetup.sh
          
          # -----------------------------------------------------------------
          # 警告: 你必须修改 'omni_oplus_13' 
          # 这应该是你的 'lunch' 目标
          # -----------------------------------------------------------------
          export ALLOW_MISSING_DEPENDENCIES=true
          export FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER=1
          lunch omni_oplus_13-eng
          
          # 开始编译 'recoveryimage'
          mka recoveryimage -j$(nproc --all)

      # 步骤 5: 上传编译产物 (recovery.img)
      - name: 5. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: OrangeFox-Recovery
          # -----------------------------------------------------------------
          # 警告: 你必须修改 'out/target/product/oplus_13/recovery.img'
          # 这应该是指向你编译生成的 recovery.img 文件的确切路径
          # -----------------------------------------------------------------
          path: ~/orangefox/out/target/product/oplus_13/recovery.img
