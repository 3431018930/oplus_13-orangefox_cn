# .github/workflows/build.yml

# å·¥ä½œæµçš„åç§°
name: ç¼–è¯‘ OrangeFox æ¢å¤

# è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  # å½“æœ‰ä»£ç æ¨é€åˆ° 'main' æˆ– 'master' åˆ†æ”¯æ—¶
  push:
    branches:
      - main
      - master
  # å…è®¸ä½ ä» GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:

jobs:
  build:
    # ä½¿ç”¨æ˜ç¡®çš„ Ubuntu ç‰ˆæœ¬ä»¥ç¡®ä¿ç¯å¢ƒç¨³å®šæ€§
    runs-on: ubuntu-22.04

    steps:
      # æ­¥éª¤ 1: ğŸ”‘ é…ç½® SSH è®¤è¯ (è§£å†³ repo sync è®¤è¯é—®é¢˜)
      # ç¡®ä¿ä½ å·²åœ¨ä»“åº“ Secret ä¸­æ·»åŠ äº† SSH_PRIVATE_KEY
      - name: 1. é…ç½® SSH è®¤è¯
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # æ­¥éª¤ 2: âš™ï¸ å®‰è£…æ„å»ºæ‰€éœ€çš„ä¾èµ–é¡¹ (ä¿®å¤ lib32ncurses5-dev é”™è¯¯)
      - name: 2. å®‰è£…ä¾èµ–é¡¹ (å…¼å®¹ Ubuntu 22.04+)
        run: |
          sudo apt-get update
          
          # å¯ç”¨ i386 æ¶æ„å¹¶æ›´æ–°ï¼Œä»¥ç¡®ä¿èƒ½å®‰è£… 32 ä½å…¼å®¹åº“
          sudo dpkg --add-architecture i386
          sudo apt-get update
          
          # æ ¸å¿ƒä¾èµ–åŒ…åˆ—è¡¨ã€‚ç§»é™¤äº†åºŸå¼ƒçš„ lib32* åŒ…ï¼Œå¹¶åŠ å…¥äº† 32 ä½å…¼å®¹åº“
          sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib \
          gcc-multilib git gnupg gperf imagemagick libelf-dev liblz4-tool libncurses5-dev \
          libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool \
          squashfs-tools xsltproc zip zlib1g-dev openjdk-11-jdk python3 \
          libncurses5:i386 libstdc++6:i386 libz1:i386

      # æ­¥éª¤ 3: åˆå§‹åŒ–å¹¶åŒæ­¥ OrangeFox æºç 
      - name: 3. ğŸ¦Š åˆå§‹åŒ–å’ŒåŒæ­¥ OrangeFox æºç 
        run: |
          # é…ç½® git
          git config --global user.name "Build Bot"
          git config --global user.email "buildbot@github.com"
          
          # åˆ›å»ºå·¥ä½œç›®å½•å¹¶è¿›å…¥
          mkdir -p ~/orangefox ~/bin
          export PATH=~/bin:$PATH
          
          # ä¸‹è½½ 'repo' å·¥å…·
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          
          cd ~/orangefox
          
          # åˆå§‹åŒ– OrangeFox 12.1 æºç åº“
          repo init -u https://gitlab.com/OrangeFox/manifest.git -b 12.1 --depth=1
          
          # åŒæ­¥æºç  (ä½¿ç”¨ -c å’Œ -j ä¼˜åŒ–é€Ÿåº¦)
          repo sync -c --no-tags --no-clone-bundle --force-sync -j$(nproc)

      # æ­¥éª¤ 4: å…‹éš†ä½ çš„è®¾å¤‡æ ‘
      - name: 4. ğŸŒ³ å…‹éš†è®¾å¤‡æ ‘
        run: |
          cd ~/orangefox
          # âš ï¸ **å¿…æ”¹é¡¹ #1:** ç¡®ä¿è·¯å¾„ä¸ä½ çš„è®¾å¤‡æ ‘ç»“æ„åŒ¹é…
          git clone https://github.com/3431018930/oplus_13-orangefox_cn.git device/oplus/oplus_13

      # æ­¥éª¤ 5: å¼€å§‹ç¼–è¯‘
      - name: 5. ğŸ”¨ è¿è¡Œç¼–è¯‘
        run: |
          cd ~/orangefox
          
          # è®¾ç½®æ„å»ºç¯å¢ƒ
          . build/envsetup.sh
          
          # âš ï¸ **å¿…æ”¹é¡¹ #2:** ç¡®ä¿ 'lunch' ç›®æ ‡æ­£ç¡®
          export ALLOW_MISSING_DEPENDENCIES=true
          export FOX_USE_TWRP_RECOVERY_IMAGE_BUILDER=1
          lunch omni_oplus_13-eng
          
          # å¼€å§‹ç¼–è¯‘ 'recoveryimage'
          mka recoveryimage -j$(nproc)

      # æ­¥éª¤ 6: ä¸Šä¼ ç¼–è¯‘äº§ç‰© (recovery.img)
      - name: 6. ğŸ“¤ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          # äº§ç‰©åç§°åŒ…å« Git SHAï¼Œæ–¹ä¾¿åŒºåˆ†
          name: OrangeFox-Recovery-${{ github.sha }}
          # âš ï¸ **å¿…æ”¹é¡¹ #3:** ç¡®ä¿äº§ç‰©è·¯å¾„æ­£ç¡®
          path: ~/orangefox/out/target/product/oplus_13/recovery.img
          retention-days: 7
